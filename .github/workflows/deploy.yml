name: Deploy docs to dev

on: pull_request

env:
  PR_NUMBER: ${{ github.event.number }}

jobs:
  trigger:
    if: github.repository == 'timescale/docs'
    permissions:
      pull-requests: write
    name: Docs dev deploy
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        id: timescale
        run: |
          echo "DEV_FOLDER=$(echo ${GITHUB_HEAD_REF})" >> $GITHUB_OUTPUT
          echo "HYPHENATED_BRANCH_NAME=$(echo "${GITHUB_HEAD_REF}" | sed 's|/|-|')" >> $GITHUB_ENV

      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@26b39ed245ab8f31526069329e112ab2fb224588
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: timescale/web-documentation
          event-type: build-docs-content
          client-payload: '{"branch": "${{ steps.timescale.outputs.DEV_FOLDER }}", "pr_number": "${{ env.PR_NUMBER }}"}'

      - name: Write comment with build link
        uses: marocchino/sticky-pull-request-comment@3d60a5b2dae89d44e0c6ddc69dd7536aec2071cd
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: Preview link
          message: |
            Allow 10 minutes from last push for the staging site to build. If the link doesn't work, try using incognito mode instead. For internal reviewers, check web-documentation repo actions for staging build status. Link to build for this PR: <a href="https://docs-dev.timescale.com/docs-${{ env.HYPHENATED_BRANCH_NAME }}" target="_blank">http://docs-dev.timescale.com/docs-${{ env.HYPHENATED_BRANCH_NAME }}</a>

  changed-files:
    name: Check for deleted and moved files
    runs-on: ubuntu-latest
    if: github.repository == 'timescale/docs'
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c
        with:
          fetch-depth: 2
      - name: Get deleted and moved files
        id: get-filenames
        run: |
          CHANGED_FILES="$(git diff --name-status HEAD~1 HEAD | awk '/^D|R/ {print}')"
          if [[ "$CHANGED_FILES" != "" ]]; then
            echo "FILES_CHANGED=true" >> $GITHUB_OUTPUT
            cat > ./tmp-changed-files.txt <<- EOM
            # Changed files
            
            The following files were changed in this PR. Check if they need any
            redirects and add to .data/redirects.json.
            EOM
            cat "$FILES_CHANGED" >> ./tmp-changed-files.txt
          fi
      - name: Write comment with renamed or deleted files
        if: (steps.get-filenames.outputs.FILES_CHANGED == 'true')
        uses: marocchino/sticky-pull-request-comment@3d60a5b2dae89d44e0c6ddc69dd7536aec2071cd
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: Deleted and renamed files
          path: ./tmp-changed-files.txt
